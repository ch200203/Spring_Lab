# Spring 핵심원리 기본편_4

## 싱글톤 컨테이너

### 웹 어플리케이션과 싱글톤

- 스프링 어플리케이션 
    - 대부분 웹 어플리케이션
    - 이외에도 데몬, 배치 어플리케이션도 존재함
- 웹 어플리케이션은 보통 여러 고객이 동시에 요청을 보냄
- 기존에 개발한 `AppConfig는` 요청을 할 떄 마다 객체를 새로 생성한다.
- 고객 트래픽이 초당 100인 경우 -> 초당 100개의 객체가 생성되고 소멸되는데, 이런 경우 **메모리의 낭비**가 심하다.
- 따라서, 객체가 1개만 생성되고, 이를 공유 하도록 설계하면 된다.
    - **싱글톤 패턴**


### 싱글톤 패턴
- 클래스의 인스턴가 딱 1개만 생성되는 것을 보장하는 디자인 패턴
- 객체 인스턴스를 2개이상 생성하지 못하도록 제한
    - `private` 생성자를 사용하여 외부에서 임의로 `new`키워드 를 사용하지 못하게 제한한다.
- `static` 영역에 객체 `instance를` 미리 하나 생성해서 올려둔다.
- 이 객체 인스턴스가 필요하면 오직 `getInstance()` 메서드를 통해서만 조회할 수 있다. 이 메서드를 호출하면 항상 같은 인스턴스를 반환한다.
- 딱 1개의 객체 인스턴스만 존재해야 하므로, 생성자를 private으로 막아서 혹시라도 외부에서 `new` 키워드로 객체 인스턴스가 생성되는 것을 막는다.
- 싱글톤을 구현하는 방법에는 다양한 방법이 존재
    - 객체를 미리 생성해두는 가장 단순하고 안전한 방법을 선택.
    - 보통은 스프링이 해결해줌

### 싱글톤 패턴 문제점
- 싱글톤 패턴을 구현하는 코드 자체가 많이 들어간다.
- 의존관계상 클라이언트가 구체 클래스에 의존한다. -> DIP를 위반한다.
- 클라이언트가 구체 클래스에 의존해서 OCP 원칙을 위반할 가능성이 높다.
- 테스트하기 복잡하다.
- 내부 속성을 변경하거나 초기화 하기 어렵나다.
- `private` 생성자로 자식 클래스를 만들기 어렵다 -> 유연성이 떨어짐
- 안티패턴으로 불리기도 한다.

### 싱글톤 컨테이너

- 스프링 컨테이너는 기존 싱글톤 패턴의 문제점을 해결하고, 객체  
인스턴스를 싱글톤으로 관리한다.
    - 스프링 빈 -> 싱글톤으로 관리되는 빈
    - 스프링 빈 저장소에서 객체를 관리
- 스프링 컨테이너는 싱글턴 배턴을 적용하지 않아도, 객체 인스턴스를 싱글톤으로 관리한다.
    - 컨테이너는 객체를 하나만 생성해서 관리한다.
- 스프링 컨테이너는 싱글톤 컨테이너 역할을 한다. 이렇게 싱글톤 객체를 생성하고 관리하는 기능 -> **싱글톤 레지스트리**
- 스프링 컨테이너의 장점
    - 싱글톤 패턴을 위한 지저분한 코드가 들어가지 않아도 된다.
    - `DIP`, `OCP`, `테스트`, `private` 생성자로 부터 자유롭게 싱글톤을 사용할 수 있다.
- 스프링 컨테이너 덕분에 고객의 요청이 올 때 마다 객체를 생성하는 것이 아닌, 이미 생성한 객체를 스프링 컨터이너에서 공유하여 사용한다.
- 스프링 긴 등록 방식은 싱글톤 이지만, 싱글톤 방식만을 지원하는 것은 아님, 새로운 객체를 생성해서 반환하는 기능도 존재
    - 단, 대부분은 싱글톤으로 사용한다.

### 싱글톤 방식의 주의점

- 싱글톤 방식은 여얼 클라이언트가 하나의 같은 객체 인스턴스를 공유하기 때문에 싱글톤 객체는 상태를 **유지(state)하게 설계하면 안된다.**
- **무상태(stateless)로 설계해야 한다.**
    - 특정 클라이언트애 의존적인 필드가 있으면 안된다.
    - 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다!
    - 가급적 읽기만 가능해야 한다.
    - 필드 대신에 자바에서 공유되지 않는 `지역변수`, `파라미터`, `ThreadLocal` 등을 사용해야 한다.
- 스프링 빈의 필드에 공유 값을 설정하면 정말 큰 장애가 발생 할 수 있음.
